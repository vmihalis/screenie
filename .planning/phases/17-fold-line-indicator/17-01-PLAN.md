---
phase: 17-fold-line-indicator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/output/reporter.ts
  - src/output/types.ts
  - src/output/__tests__/reporter.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User sees horizontal dashed line at viewport height on thumbnail screenshots"
    - "User sees horizontal dashed line at viewport height in lightbox view"
    - "Fold line uses semi-transparent dashed styling that doesn't obscure content"
    - "Fold line position adjusts correctly when browser window is resized"
    - "Fold line is rendered via CSS (not baked into screenshot image)"
  artifacts:
    - path: "src/output/reporter.ts"
      provides: "PNG dimension extraction, fold position calculation, CSS fold line styles, updated HTML rendering"
      exports: ["getPngDimensions", "calculateFoldPositions"]
    - path: "src/output/types.ts"
      provides: "Extended ScreenshotForReport type with fold position fields"
      contains: "screenshotWidth"
  key_links:
    - from: "src/output/reporter.ts"
      to: "ScreenshotForReport type"
      via: "prepareScreenshotsForReport uses getPngDimensions to populate fold fields"
      pattern: "getPngDimensions.*buffer"
    - from: "renderThumbnailCard"
      to: "--fold-position CSS custom property"
      via: "inline style attribute"
      pattern: "--fold-position.*%"
    - from: "renderLightbox"
      to: "--fold-position CSS custom property"
      via: "lightbox-content wrapper div"
      pattern: "lightbox-content.*--fold-position"
---

<objective>
Implement fold line indicator showing viewport boundary on all screenshots in the HTML report.

Purpose: Users currently cannot tell where the "above the fold" content ends on full-page screenshots. A visual indicator shows exactly what users see without scrolling.

Output:
- PNG dimension extraction utility (no external dependencies)
- Fold position calculation for thumbnail and lightbox views
- CSS styles for semi-transparent dashed fold line
- Updated HTML rendering with fold line positioning
- Unit tests for all new functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/17-fold-line-indicator/17-RESEARCH.md

# Key source files
@src/output/reporter.ts
@src/output/types.ts
@src/output/__tests__/reporter.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PNG dimension extraction and fold calculation utilities</name>
  <files>src/output/reporter.ts, src/output/types.ts</files>
  <action>
1. In `src/output/types.ts`, extend `ScreenshotForReport` interface to add:
   - `screenshotWidth: number` - Actual screenshot width in pixels
   - `screenshotHeight: number` - Actual screenshot height in pixels
   - `foldPositionLightbox: number` - Fold as percentage of screenshot height
   - `foldPositionThumbnail: number | null` - Fold as percentage of visible thumbnail area (null if fold is below visible area)

2. In `src/output/reporter.ts`, add new exported functions:

   `getPngDimensions(buffer: Buffer): { width: number; height: number }`
   - Verify PNG signature (bytes 0-7: 89 50 4E 47 0D 0A 1A 0A)
   - Read width from bytes 16-19 (big-endian uint32)
   - Read height from bytes 20-23 (big-endian uint32)
   - Throw Error with message "Invalid PNG file: incorrect signature" if signature doesn't match

   `calculateFoldPositions(viewportHeight: number, screenshotWidth: number, screenshotHeight: number): { lightboxPercent: number; thumbnailPercent: number | null }`
   - `lightboxPercent = (viewportHeight / screenshotHeight) * 100`
   - For thumbnail with aspect ratio 16/10 = 1.6:
     - Calculate `screenshotAspectRatio = screenshotWidth / screenshotHeight`
     - Calculate `visibleHeightPercent = min(100, (1.6 / screenshotAspectRatio) * 100)`
     - If `lightboxPercent > visibleHeightPercent`, return `thumbnailPercent: null` (fold is below visible area)
     - Otherwise `thumbnailPercent = (lightboxPercent / visibleHeightPercent) * 100`

3. Update `prepareScreenshotsForReport()` to:
   - Call `getPngDimensions(result.buffer)` to get actual screenshot dimensions
   - Call `calculateFoldPositions(device.height, screenshotWidth, screenshotHeight)`
   - Populate the new fields on `ScreenshotForReport`

Note: Use THUMBNAIL_ASPECT_RATIO constant = 16/10 = 1.6 to match CSS.
  </action>
  <verify>
    - `npm run typecheck` passes
    - Existing tests still pass: `npm test -- src/output/__tests__/reporter.test.ts`
  </verify>
  <done>
    - `ScreenshotForReport` type extended with 4 new fields
    - `getPngDimensions()` extracts dimensions from PNG buffer
    - `calculateFoldPositions()` returns correct percentages for lightbox and thumbnail
    - `prepareScreenshotsForReport()` populates all fold position fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSS fold line styles and update HTML rendering</name>
  <files>src/output/reporter.ts</files>
  <action>
1. Update `CSS_STYLES` constant to add fold line styles:

   For `.thumbnail-link`:
   - Keep existing styles
   - Add `position: relative;` (if not already present)
   - Add `::after` pseudo-element with:
     - `content: '';`
     - `position: absolute;`
     - `left: 0; right: 0;`
     - `top: var(--fold-position, 200%);` (default hidden off-screen)
     - `height: 0;`
     - `border-top: 2px dashed rgba(255, 100, 100, 0.5);`
     - `pointer-events: none;`
     - `z-index: 10;`

   For lightbox, add new `.lightbox-content` class:
   - `position: relative;`
   - `display: inline-block;`
   - Same `::after` pseudo-element as thumbnail

2. Update `renderThumbnailCard()`:
   - Build fold style: If `screenshot.foldPositionThumbnail !== null`, create `style="--fold-position: ${value.toFixed(2)}%;"` attribute
   - Apply style to the `.thumbnail-link` anchor element

3. Update `renderLightbox()`:
   - Wrap the `<img>` in a `<div class="lightbox-content" style="--fold-position: ${foldPositionLightbox.toFixed(2)}%;">`
   - The fold line appears on this wrapper, positioned relative to the image

Important styling notes:
- Use `rgba(255, 100, 100, 0.5)` for semi-transparent coral/red (good contrast, not harsh)
- Use `dashed` border style per FOLD-04 requirement
- Keep line thin (2px) per FOLD-04 non-intrusive requirement
- Default `200%` positions fold off-screen when CSS variable is not set
  </action>
  <verify>
    - `npm run typecheck` passes
    - Run `npm run build` to ensure reporter compiles
    - Manual verification: Run `npx screenie https://example.com --phones-only` and inspect report.html in browser:
      - Thumbnail cards show horizontal dashed line
      - Clicking to lightbox shows fold line on enlarged view
      - Line is semi-transparent coral/red dashed
  </verify>
  <done>
    - CSS includes `.thumbnail-link::after` and `.lightbox-content::after` fold line styles
    - `renderThumbnailCard()` adds `--fold-position` style when fold is visible
    - `renderLightbox()` wraps image in `.lightbox-content` div with fold position
    - Fold lines render correctly in browser at viewport boundary
  </done>
</task>

<task type="auto">
  <name>Task 3: Add comprehensive tests for fold line functionality</name>
  <files>src/output/__tests__/reporter.test.ts</files>
  <action>
Add test suites for new functionality:

1. `describe('getPngDimensions')`:
   - Test with valid PNG buffer (create minimal valid PNG header in test)
   - Test extracts correct width and height
   - Test throws "Invalid PNG file: incorrect signature" for non-PNG buffer
   - Test throws for buffer too short

2. `describe('calculateFoldPositions')`:
   - Test lightboxPercent calculation: viewport 852px, screenshot height 3000px -> 28.4%
   - Test thumbnailPercent when fold is visible: short page where fold is above thumbnail crop
   - Test thumbnailPercent is null when fold is below visible area (very tall screenshot)
   - Test edge case: viewport equals screenshot height (fold at 100%)
   - Test with different aspect ratios

3. Update `describe('prepareScreenshotsForReport')`:
   - Create test that verifies new fields are populated
   - Use a valid PNG buffer (can use real small PNG or construct minimal valid header)
   - Verify screenshotWidth, screenshotHeight, foldPositionLightbox, foldPositionThumbnail are set

4. Update `describe('HTML Template Output')`:
   - Test thumbnail card includes `style="--fold-position:` when fold is visible
   - Test thumbnail card does NOT include fold style when thumbnailPercent is null
   - Test lightbox includes `class="lightbox-content"` wrapper div
   - Test lightbox wrapper has `--fold-position` style
   - Test CSS output includes `.thumbnail-link::after` styles
   - Test CSS output includes `.lightbox-content::after` styles

Create helper to generate minimal valid PNG buffer for tests:
```typescript
function createTestPngBuffer(width: number, height: number): Buffer {
  // PNG signature (8 bytes)
  const signature = Buffer.from([0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]);
  // IHDR chunk: length (13) + "IHDR" + width + height + bit depth + color type + compression + filter + interlace
  const ihdrData = Buffer.alloc(25);
  ihdrData.writeUInt32BE(13, 0);  // chunk length
  ihdrData.write('IHDR', 4);       // chunk type
  ihdrData.writeUInt32BE(width, 8);
  ihdrData.writeUInt32BE(height, 12);
  ihdrData.writeUInt8(8, 16);     // bit depth
  ihdrData.writeUInt8(2, 17);     // color type (RGB)
  ihdrData.writeUInt8(0, 18);     // compression
  ihdrData.writeUInt8(0, 19);     // filter
  ihdrData.writeUInt8(0, 20);     // interlace
  // CRC (can be invalid for dimension extraction tests)
  ihdrData.writeUInt32BE(0, 21);
  return Buffer.concat([signature, ihdrData]);
}
```
  </action>
  <verify>
    - All tests pass: `npm test -- src/output/__tests__/reporter.test.ts`
    - Coverage for new functions: getPngDimensions, calculateFoldPositions
    - No regressions in existing tests
  </verify>
  <done>
    - Tests cover getPngDimensions with valid/invalid inputs
    - Tests cover calculateFoldPositions with various screenshot dimensions
    - Tests verify prepareScreenshotsForReport populates fold fields
    - Tests verify HTML output includes fold line CSS and inline styles
    - All 291+ tests pass
  </done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
npm test
```

Run typecheck:
```bash
npm run typecheck
```

Manual verification:
```bash
# Capture screenshots of a real site
npx screenie https://news.ycombinator.com --phones-only

# Open the generated report in browser
# Verify:
# 1. Thumbnail cards show dashed coral line at viewport height
# 2. Click to open lightbox - line appears on full-size image
# 3. Line is semi-transparent and non-intrusive
# 4. Resize browser window - line position stays correct (percentage-based)
```
</verification>

<success_criteria>
Requirements coverage:
- FOLD-01: Horizontal line overlay displayed at viewport height on each screenshot
- FOLD-02: Fold line visible on thumbnails in grid view
- FOLD-03: Fold line visible on enlarged view (lightbox)
- FOLD-04: Fold line uses non-intrusive styling (dashed, semi-transparent)
- FOLD-05: Fold line positioned via CSS (not baked into screenshot image)

Measurable completion:
- All tests pass (npm test)
- TypeScript compiles (npm run typecheck)
- Build succeeds (npm run build)
- Manual verification confirms fold line visible on real screenshots
</success_criteria>

<output>
After completion, create `.planning/phases/17-fold-line-indicator/17-01-SUMMARY.md`
</output>
