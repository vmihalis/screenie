---
phase: 07-html-report
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/output/reporter.ts
  - src/output/types.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Report displays all screenshots in responsive grid"
    - "Screenshots grouped by device category with headers"
    - "Thumbnails show device info (name, dimensions)"
    - "Clicking thumbnail shows full-size image"
    - "Report shows metadata (URL, timestamp, duration, device count)"
    - "Report works offline (no external dependencies)"
  artifacts:
    - path: "src/output/reporter.ts"
      provides: "HTML report generation with all templates and helpers"
      exports: ["generateReport"]
      min_lines: 200
    - path: "src/output/types.ts"
      provides: "ScreenshotForReport interface"
      contains: "interface ScreenshotForReport"
  key_links:
    - from: "src/output/reporter.ts"
      to: "src/output/types.ts"
      via: "import ScreenshotForReport"
      pattern: "import.*ScreenshotForReport"
    - from: "src/output/reporter.ts"
      to: "src/devices/types.ts"
      via: "import DeviceCategory"
      pattern: "import.*DeviceCategory"
---

<objective>
Implement HTML report generation with responsive grid layout, category grouping, CSS-only lightbox, and embedded base64 images.

Purpose: Create self-contained HTML report that displays all captured screenshots organized by device category with click-to-enlarge functionality.

Output: Working `generateReport()` function that produces a complete HTML file with all screenshots embedded.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-html-report/07-RESEARCH.md
@src/output/types.ts
@src/output/reporter.ts
@src/output/organizer.ts
@src/devices/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ScreenshotForReport interface and extend types</name>
  <files>src/output/types.ts</files>
  <action>
Add new interface for report-specific screenshot data:

```typescript
/**
 * Screenshot data prepared for HTML report generation
 */
export interface ScreenshotForReport {
  /** Device display name */
  deviceName: string;
  /** Device category for grouping */
  category: DeviceCategory;
  /** Viewport width */
  width: number;
  /** Viewport height */
  height: number;
  /** Base64 data URI (data:image/png;base64,...) */
  dataUri: string;
}
```

Place after existing interfaces. Keep existing interfaces unchanged.
  </action>
  <verify>
`grep -n "ScreenshotForReport" src/output/types.ts` shows interface definition.
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>ScreenshotForReport interface exists with deviceName, category, width, height, dataUri fields.</done>
</task>

<task type="auto">
  <name>Task 2: Implement reporter helper functions</name>
  <files>src/output/reporter.ts</files>
  <action>
Replace placeholder with full implementation. Add these helper functions:

1. **escapeHtml(str: string): string** - Escape HTML special chars (<, >, &, ", ')
2. **bufferToDataUri(buffer: Buffer): string** - Convert Buffer to base64 data URI
3. **formatDuration(ms: number): string** - Format ms to human readable (e.g., "1m 23s")
4. **generateLightboxId(deviceName: string, width: number, height: number): string** - Create unique HTML-safe ID (prefix with "lb-", sanitize name)
5. **groupByCategory(screenshots: ScreenshotForReport[]): Map<DeviceCategory, ScreenshotForReport[]>** - Group screenshots by category
6. **getCategoryDisplayName(category: DeviceCategory): string** - Map category to display name ('phones' -> 'Phones', 'tablets' -> 'Tablets', 'pc-laptops' -> 'Desktop & Laptops')

All functions should be exported for testing.

Use patterns from research:
- escapeHtml: replace &, <, >, ", ' with entities
- bufferToDataUri: `data:image/png;base64,${buffer.toString('base64')}`
- generateLightboxId: lowercase, replace non-alphanumeric with hyphen, prefix "lb-"
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Helper functions are exported: `grep "export function" src/output/reporter.ts`
  </verify>
  <done>Six helper functions exported: escapeHtml, bufferToDataUri, formatDuration, generateLightboxId, groupByCategory, getCategoryDisplayName.</done>
</task>

<task type="auto">
  <name>Task 3: Implement CSS styles and HTML template functions</name>
  <files>src/output/reporter.ts</files>
  <action>
Add CSS styles constant and HTML generation functions:

1. **CSS_STYLES constant** - Complete CSS from research including:
   - Reset and base styles (box-sizing, font-family)
   - Report header with metadata flex layout
   - Category sections with h2 border
   - Thumbnail grid with CSS Grid auto-fit/minmax(280px, 1fr)
   - Thumbnail cards with aspect-ratio: 16/10, object-fit: cover
   - Lightbox styles with :target pseudo-class
   - Close button positioned absolute top-right

2. **renderHeader(data: ReportData): string** - Generate header HTML with h1 title and metadata grid

3. **renderThumbnailCard(screenshot: ScreenshotForReport): string** - Generate thumbnail card with:
   - Link to lightbox (href="#lb-...")
   - Image with dataUri src
   - Device name and dimensions text

4. **renderCategory(category: DeviceCategory, screenshots: ScreenshotForReport[]): string** - Generate category section with:
   - h2 with display name
   - thumbnail-grid div with all thumbnail cards

5. **renderLightbox(screenshot: ScreenshotForReport): string** - Generate lightbox HTML with:
   - Anchor with id="lb-..."
   - Close link (href="#_")
   - Full-size image
   - Device info text below

6. **buildReportHtml(data: ReportData, screenshots: ScreenshotForReport[]): string** - Assemble complete HTML:
   - DOCTYPE and html/head/body structure
   - Inline style tag with CSS_STYLES
   - Header from renderHeader
   - Main with categories in order: phones, tablets, pc-laptops
   - All lightboxes at end of body

Use template literals for all HTML generation. No external dependencies.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
CSS_STYLES constant exists: `grep "CSS_STYLES" src/output/reporter.ts`
Template functions exist: `grep "function render" src/output/reporter.ts`
  </verify>
  <done>CSS_STYLES constant and 5 render functions (renderHeader, renderThumbnailCard, renderCategory, renderLightbox, buildReportHtml) implemented.</done>
</task>

<task type="auto">
  <name>Task 4: Implement generateReport function</name>
  <files>src/output/reporter.ts</files>
  <action>
Update the exported generateReport function signature and implementation:

```typescript
import { writeFile } from 'node:fs/promises';
import { join } from 'node:path';
import type { ReportData, ScreenshotForReport } from './types.js';
import type { DeviceCategory } from '../devices/types.js';

export async function generateReport(
  data: ReportData,
  screenshots: ScreenshotForReport[],
  outputPath: string
): Promise<string> {
  const html = buildReportHtml(data, screenshots);
  const reportPath = join(outputPath, 'report.html');
  await writeFile(reportPath, html, 'utf-8');
  return reportPath;
}
```

The function:
1. Calls buildReportHtml to generate complete HTML string
2. Writes to 'report.html' in the output directory
3. Returns the full path to the report file

Also add a convenience function to convert execution results to report format:

```typescript
import type { ExecutionResult } from '../engine/types.js';
import type { Device } from '../devices/types.js';

export function prepareScreenshotsForReport(
  results: ExecutionResult[],
  devices: Device[]
): ScreenshotForReport[] {
  const deviceMap = new Map<string, Device>();
  for (const device of devices) {
    deviceMap.set(device.name, device);
  }

  const screenshots: ScreenshotForReport[] = [];
  for (const result of results) {
    if (!result.success || !result.buffer) continue;
    const device = deviceMap.get(result.deviceName);
    if (!device) continue;

    screenshots.push({
      deviceName: device.name,
      category: device.category,
      width: device.width,
      height: device.height,
      dataUri: bufferToDataUri(result.buffer),
    });
  }

  return screenshots;
}
```

This bridges ExecutionResult[] to ScreenshotForReport[] for easier pipeline integration.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Project builds: `npm run build`
Functions exported: `grep "export.*function.*generateReport\|prepareScreenshotsForReport" src/output/reporter.ts`
  </verify>
  <done>generateReport writes HTML file, prepareScreenshotsForReport converts execution results to report format.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. `npx tsc --noEmit` shows no type errors
3. `grep -c "export" src/output/reporter.ts` shows multiple exports
4. All interfaces and functions exist as specified
</verification>

<success_criteria>
- src/output/types.ts has ScreenshotForReport interface
- src/output/reporter.ts exports generateReport, prepareScreenshotsForReport, and all helper functions
- HTML generation uses template literals with inline CSS
- CSS Grid with auto-fit/minmax for responsive layout
- CSS :target lightbox for click-to-enlarge
- Base64 data URIs for self-contained HTML
- Category grouping with display names
- Metadata section with URL, timestamp, duration, device count
</success_criteria>

<output>
After completion, create `.planning/phases/07-html-report/07-01-SUMMARY.md`
</output>
