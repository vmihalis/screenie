---
phase: 07-html-report
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/output/__tests__/reporter.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Helper functions work correctly"
    - "HTML escaping prevents XSS"
    - "Base64 encoding produces valid data URIs"
    - "Duration formatting is human-readable"
    - "Category grouping organizes screenshots correctly"
    - "Generated HTML is valid and self-contained"
  artifacts:
    - path: "src/output/__tests__/reporter.test.ts"
      provides: "Unit and integration tests for reporter module"
      min_lines: 150
  key_links:
    - from: "src/output/__tests__/reporter.test.ts"
      to: "src/output/reporter.ts"
      via: "import helper functions"
      pattern: "import.*from.*reporter"
---

<objective>
Add comprehensive tests for HTML report generation including helper functions, HTML template output, and integration tests.

Purpose: Verify all reporter functionality works correctly and produces valid self-contained HTML.

Output: Test suite covering helpers, templates, and full report generation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-html-report/07-01-SUMMARY.md
@src/output/reporter.ts
@src/output/types.ts
@src/output/__tests__/organizer.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test helper functions</name>
  <files>src/output/__tests__/reporter.test.ts</files>
  <action>
Create new test file with tests for all helper functions.

Follow project conventions from organizer.test.ts:
- Import from '../reporter.js' (ESM .js extension)
- Use describe/it blocks
- Import type from types.ts

**escapeHtml tests:**
- Escapes < > & " '
- Handles strings without special chars (returns unchanged)
- Handles empty string
- Handles URL with query params (& becomes &amp;)

**bufferToDataUri tests:**
- Converts Buffer to data:image/png;base64,... format
- Output starts with "data:image/png;base64,"
- Can decode back to original buffer (Buffer.from(base64Part, 'base64'))

**formatDuration tests:**
- Under 60s: returns "Xs" (e.g., 45000 -> "45s")
- 60+ seconds: returns "Xm Ys" (e.g., 123000 -> "2m 3s")
- Exactly 60s: returns "1m 0s"
- Rounds to nearest second

**generateLightboxId tests:**
- Generates valid HTML ID (starts with "lb-")
- Sanitizes special characters (spaces, punctuation)
- Includes dimensions
- Example: "iPhone 15 Pro", 393, 852 -> "lb-iphone-15-pro-393x852"

**groupByCategory tests:**
- Groups empty array -> empty Map
- Groups single category
- Groups multiple categories correctly
- Order within category preserved

**getCategoryDisplayName tests:**
- 'phones' -> 'Phones'
- 'tablets' -> 'Tablets'
- 'pc-laptops' -> 'Desktop & Laptops'
  </action>
  <verify>
`npm test -- --run reporter.test.ts` passes all helper function tests
  </verify>
  <done>All 6 helper functions have passing tests covering edge cases.</done>
</task>

<task type="auto">
  <name>Task 2: Test HTML template functions</name>
  <files>src/output/__tests__/reporter.test.ts</files>
  <action>
Add tests for HTML generation functions. Create test fixtures:

```typescript
const mockScreenshot: ScreenshotForReport = {
  deviceName: 'iPhone 15 Pro',
  category: 'phones',
  width: 393,
  height: 852,
  dataUri: 'data:image/png;base64,iVBORw0KGgo=', // minimal valid base64
};

const mockReportData: ReportData = {
  url: 'https://example.com',
  capturedAt: '2026-01-20 12:00:00',
  duration: 45000,
  deviceCount: 3,
  files: [],
};
```

**renderHeader tests:**
- Contains h1 with "Responsive Screenshots"
- Contains escaped URL
- Contains formatted duration
- Contains device count

**renderThumbnailCard tests:**
- Contains link with href to lightbox ID
- Contains img with dataUri src
- Contains device name
- Contains dimensions text

**renderCategory tests:**
- Contains h2 with category display name
- Contains thumbnail-grid class div
- Contains all thumbnail cards for category
- Empty array produces no thumbnail cards

**renderLightbox tests:**
- Contains correct ID attribute
- Contains close link (href="#_")
- Contains full-size image with dataUri
- Contains device info text

**buildReportHtml tests:**
- Contains DOCTYPE html
- Contains charset UTF-8 meta tag
- Contains style tag with CSS
- Contains header section
- Contains all three categories (phones, tablets, pc-laptops)
- Contains lightbox elements
- HTML is self-contained (no external URLs in src/href for assets)
  </action>
  <verify>
`npm test -- --run reporter.test.ts` passes all template tests
  </verify>
  <done>HTML template functions tested: renderHeader, renderThumbnailCard, renderCategory, renderLightbox, buildReportHtml.</done>
</task>

<task type="auto">
  <name>Task 3: Test generateReport and prepareScreenshotsForReport</name>
  <files>src/output/__tests__/reporter.test.ts</files>
  <action>
Add integration tests for main exported functions.

**prepareScreenshotsForReport tests:**
- Converts ExecutionResult[] to ScreenshotForReport[]
- Skips failed results (success: false)
- Skips results without buffer
- Skips results with unknown device names
- Correct deviceName, category, width, height, dataUri for each

Create test helper:
```typescript
import type { ExecutionResult } from '../../engine/types.js';
import type { Device } from '../../devices/types.js';

function createTestResult(name: string, success: boolean, buffer?: Buffer): ExecutionResult {
  return {
    success,
    deviceName: name,
    buffer,
    attempts: 1,
  };
}

function createTestDevice(name: string, category: DeviceCategory): Device {
  return {
    name,
    width: 393,
    height: 852,
    deviceScaleFactor: 3,
    category,
  };
}
```

**generateReport tests:**
Use temp directory pattern from organizer.test.ts:
- Creates report.html file in output directory
- Returns correct file path
- File contains valid HTML (check for DOCTYPE, html tags)
- File is non-empty
- Works with empty screenshots array (produces valid HTML)

Test with real filesystem:
```typescript
import { mkdir, rm, readFile } from 'node:fs/promises';
import { join } from 'node:path';

const TEST_OUTPUT_DIR = '.test-output-reporter';

beforeEach(async () => {
  await mkdir(TEST_OUTPUT_DIR, { recursive: true });
});

afterEach(async () => {
  await rm(TEST_OUTPUT_DIR, { recursive: true, force: true });
});
```
  </action>
  <verify>
`npm test -- --run reporter.test.ts` passes all tests
`npm test` runs full test suite successfully (all ~100+ tests)
  </verify>
  <done>Integration tests pass: prepareScreenshotsForReport converts data correctly, generateReport writes valid HTML file.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm test` passes (all tests including new reporter tests)
2. Test count increased by ~25-30 tests
3. All helper functions covered
4. HTML output verified to be self-contained
</verification>

<success_criteria>
- src/output/__tests__/reporter.test.ts exists with comprehensive tests
- All 6 helper functions tested with edge cases
- All 5 template functions tested for correct HTML output
- generateReport integration test verifies file creation
- prepareScreenshotsForReport integration test verifies data conversion
- Total test count: ~120+ (was 97)
- All tests pass: `npm test`
</success_criteria>

<output>
After completion, create `.planning/phases/07-html-report/07-02-SUMMARY.md`
</output>
