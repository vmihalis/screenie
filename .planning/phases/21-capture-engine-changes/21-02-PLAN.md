---
phase: 21-capture-engine-changes
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - src/engine/capturer.ts
  - src/cli/actions.ts
  - src/engine/__tests__/capturer.test.ts
autonomous: true

must_haves:
  truths:
    - "Default capture is viewport-only (not full page)"
    - "--full-page flag enables full-page capture"
    - "Existing tests pass with new default behavior"
  artifacts:
    - path: "src/engine/capturer.ts"
      provides: "Dynamic fullPage parameter"
      contains: "fullPage = false"
    - path: "src/cli/actions.ts"
      provides: "fullPage option passed to engine"
      contains: "fullPage:"
    - path: "src/engine/__tests__/capturer.test.ts"
      provides: "Tests for viewport-only default and fullPage option"
      contains: "fullPage"
  key_links:
    - from: "src/cli/actions.ts"
      to: "captureAllDevices"
      via: "captureOptions parameter"
      pattern: "fullPage.*options\\.fullPage"
    - from: "src/engine/capturer.ts"
      to: "page.screenshot"
      via: "fullPage option destructure"
      pattern: "fullPage.*=.*false"
---

<objective>
Implement viewport-only default capture with --full-page flag support.

Purpose: Change the default screenshot behavior from full-page to viewport-only, completing the core v3.0 feature.
Output: Working capture engine that defaults to viewport-only, with full-page available via flag. All tests pass.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-capture-engine-changes/21-RESEARCH.md
@.planning/phases/21-capture-engine-changes/21-01-SUMMARY.md

@src/engine/capturer.ts
@src/cli/actions.ts
@src/engine/__tests__/capturer.test.ts
@src/engine/executor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update capture engine for dynamic fullPage</name>
  <files>src/engine/capturer.ts</files>
  <action>
Modify `captureScreenshot` function to use dynamic `fullPage` option:

1. Add `fullPage` to destructuring (line ~29-37):
   ```typescript
   const {
     url,
     device,
     timeout = DEFAULT_TIMEOUT,
     waitBuffer = 500,
     scrollForLazy = true,
     maxScrollIterations = 10,
     hideCookieBanners: shouldHideCookies = true,
     fullPage = false,  // NEW: Default to viewport-only
   } = options;
   ```

2. Update the screenshot call (line ~69-75) to use the variable:
   ```typescript
   // SHOT-01: Screenshot with configurable full-page mode (default: viewport-only)
   const buffer = await page.screenshot({
     fullPage,  // Was: fullPage: true
     type: 'png',
     scale: 'css', // Consistent file sizes across DPRs
     animations: 'disabled', // SHOT-03: Disable CSS animations for consistency
     timeout: screenshotTimeout,
   });
   ```

3. Update the JSDoc comment at top of function (line ~7-23):
   - Change "Capture a full-page screenshot" to "Capture a screenshot"
   - Update requirement comment: "SHOT-01: Screenshot (viewport-only by default, full-page via option)"
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>captureScreenshot uses fullPage from options, defaulting to false (viewport-only)</done>
</task>

<task type="auto">
  <name>Task 2: Thread fullPage through action handler</name>
  <files>src/cli/actions.ts</files>
  <action>
Pass `fullPage` option from CLI to capture engine in `runCapture` function:

1. Update the `captureAllDevices` call (line ~70-84) to include fullPage:
   ```typescript
   const result = await captureAllDevices(
     manager,
     fullUrl,
     devices,
     {
       timeout: defaultConfig.timeout,
       waitBuffer,
       fullPage: options.fullPage ?? false,  // NEW: Default to viewport-only
     },
     {
       concurrency,
       onProgress: (done, total, res) => {
         spinner.update(done, total, res.deviceName, res.success);
       },
     }
   );
   ```

The `options.fullPage ?? false` ensures:
- `--full-page` flag present: fullPage = true
- No flag (undefined): fullPage = false (viewport-only default)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>CLI --full-page flag flows through to capture engine</done>
</task>

<task type="auto">
  <name>Task 3: Update capturer tests for new default behavior</name>
  <files>src/engine/__tests__/capturer.test.ts</files>
  <action>
Update tests to reflect viewport-only default and add fullPage option tests:

1. Rename test on line ~86 from "should capture full-page content" to "should capture viewport content (default)":
   ```typescript
   it('should capture viewport content (default)', async () => {
     // Use a page that's likely to have scrollable content
     const options: CaptureOptions = {
       url: 'https://example.com',
       device: testPhone,
       timeout: DEFAULT_TIMEOUT,
       waitBuffer: 500,
       // fullPage defaults to false (viewport-only)
     };

     const result = await captureScreenshot(manager, options);

     expect(result.success).toBe(true);
     expect(result.buffer).toBeDefined();
   });
   ```

2. Add new test for fullPage option in "successful captures" describe block:
   ```typescript
   it('should capture full-page content when fullPage: true', async () => {
     const options: CaptureOptions = {
       url: 'https://example.com',
       device: testPhone,
       timeout: DEFAULT_TIMEOUT,
       waitBuffer: 500,
       fullPage: true,  // Explicit full-page capture
     };

     const result = await captureScreenshot(manager, options);

     expect(result.success).toBe(true);
     expect(result.buffer).toBeDefined();
   });

   it('should capture viewport-only when fullPage: false', async () => {
     const options: CaptureOptions = {
       url: 'https://example.com',
       device: testPhone,
       timeout: DEFAULT_TIMEOUT,
       waitBuffer: 500,
       fullPage: false,  // Explicit viewport-only
     };

     const result = await captureScreenshot(manager, options);

     expect(result.success).toBe(true);
     expect(result.buffer).toBeDefined();
   });
   ```

Note: We test that both modes succeed. We don't test exact pixel dimensions because example.com content may vary. The key requirement is that the option is respected without errors.
  </action>
  <verify>`npm test -- src/engine/__tests__/capturer.test.ts` - all tests pass</verify>
  <done>Tests verify viewport-only default, fullPage: true, and fullPage: false all work</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. All engine tests pass: `npm test -- src/engine/__tests__/capturer.test.ts`
3. Full test suite passes: `npm test`
4. Manual test viewport-only: `npx tsx src/cli/index.ts https://example.com --phones-only --no-open` (quick test)
5. Manual test full-page: `npx tsx src/cli/index.ts https://example.com --phones-only --full-page --no-open`
</verification>

<success_criteria>
- Default capture produces viewport-height screenshots (not full page)
- --full-page flag produces full-page screenshots (original v2.2 behavior)
- All existing tests pass (updated for new default)
- New tests verify both capture modes work
- TypeScript compiles without errors
- Requirements CAP-01, CAP-02, CAP-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/21-capture-engine-changes/21-02-SUMMARY.md`
</output>
