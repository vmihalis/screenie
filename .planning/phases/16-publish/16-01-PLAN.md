---
phase: 16-publish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .github/workflows/publish.yml
autonomous: false

user_setup:
  - service: npmjs.com
    why: "Configure trusted publisher for OIDC authentication"
    dashboard_config:
      - task: "Configure trusted publisher"
        location: "npmjs.com -> Account -> Access Tokens -> Trusted Publishers (or package settings)"

must_haves:
  truths:
    - "npm info screenie returns package metadata"
    - "npm package has provenance badge on npmjs.com"
    - "npx screenie --help works without prior installation"
  artifacts:
    - path: ".github/workflows/publish.yml"
      provides: "Automated npm publishing with provenance"
      contains: "id-token: write"
  key_links:
    - from: ".github/workflows/publish.yml"
      to: "npmjs.com registry"
      via: "OIDC trusted publishing"
      pattern: "npm publish --access public"
---

<objective>
Publish screenie to npm with provenance signing for supply chain security.

Purpose: Make screenie discoverable and installable via `npx screenie` or `npm install -g screenie`, with cryptographic provenance attestation proving the package was built from this repository.

Output: Package live on npm registry with green provenance badge.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-publish/16-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix package.json repository URLs</name>
  <files>package.json</files>
  <action>
Update package.json to have correct repository URLs matching the actual GitHub repository.

Current (INCORRECT):
- repository.url: "git+https://github.com/memehalis/screenie.git"
- bugs.url: "https://github.com/memehalis/screenie/issues"

Change to (CORRECT):
- repository.url: "git+https://github.com/vmihalis/responsiveness-mcp.git"
- bugs.url: "https://github.com/vmihalis/responsiveness-mcp/issues"

This is CRITICAL for npm provenance - the repository URL in package.json must match the actual repository publishing the package. npm verifies this during trusted publishing.
  </action>
  <verify>
    grep -A2 '"repository"' package.json
    grep '"bugs"' package.json
    - repository.url contains "vmihalis/responsiveness-mcp"
    - bugs.url contains "vmihalis/responsiveness-mcp"
  </verify>
  <done>
    package.json repository and bugs URLs point to the correct GitHub repository (vmihalis/responsiveness-mcp).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions publish workflow</name>
  <files>.github/workflows/publish.yml</files>
  <action>
Create `.github/workflows/` directory and `publish.yml` workflow file.

The workflow must:
1. Trigger on `release: types: [published]` event
2. Set permissions: `contents: read` and `id-token: write` (CRITICAL for OIDC)
3. Use `actions/checkout@v4`
4. Use `actions/setup-node@v4` with node-version '20' and registry-url 'https://registry.npmjs.org'
5. Run `npm ci` to install dependencies
6. Run `npm publish --access public`

IMPORTANT: Do NOT set NODE_AUTH_TOKEN in env block. Trusted publishing uses OIDC - any env token (even empty) prevents OIDC fallback.

IMPORTANT: Do NOT add --provenance flag. Trusted publishing generates provenance automatically.

Use this exact workflow structure:
```yaml
name: Publish to npm

on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Publish to npm
        run: npm publish --access public
```
  </action>
  <verify>
    cat .github/workflows/publish.yml
    - File exists with correct content
    - Contains `id-token: write` permission
    - Contains `release: types: [published]` trigger
    - Does NOT contain NODE_AUTH_TOKEN
    - Does NOT contain --provenance flag
  </verify>
  <done>
    Workflow file exists at `.github/workflows/publish.yml` with trusted publishing configuration.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Configure npm trusted publisher</name>
  <action>
User must configure trusted publisher on npmjs.com. This cannot be automated - requires dashboard login.
  </action>
  <instructions>
1. Go to https://www.npmjs.com and log in
2. Navigate to your account settings -> "Access Tokens" or search for "trusted publishers"
   - If package already exists: Go to package settings -> "Trusted Publishers"
   - If new package: Go to account settings -> "Trusted Publishers" -> "Link a new trusted publisher"
3. Configure trusted publisher with EXACT values (case-sensitive):
   - **Repository owner:** vmihalis
   - **Repository name:** responsiveness-mcp
   - **Workflow filename:** publish.yml (include .yml extension)
   - **Environment name:** Leave empty (not using GitHub environments)

CRITICAL: The workflow filename must EXACTLY match what you created in Task 2. Case-sensitive, include .yml extension.

4. Save the trusted publisher configuration
  </instructions>
  <resume-signal>Type "configured" when npm trusted publisher is set up, or describe any issues.</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Create GitHub release to trigger publish</name>
  <files></files>
  <action>
Use GitHub CLI to create a release, which triggers the publish workflow.

Steps:
1. Ensure all changes are committed and pushed to main/master
2. Create a git tag matching package.json version (v1.0.0)
3. Create GitHub release using `gh release create`

Commands:
```bash
# Check current version in package.json
grep '"version"' package.json

# Create and push tag (if not exists)
git tag v1.0.0
git push origin v1.0.0

# Create GitHub release (triggers workflow)
gh release create v1.0.0 --title "v1.0.0" --notes "Initial public release of screenie

## Features
- Capture responsive screenshots across 57 device dimensions
- Generate HTML reports for visual review
- Device filtering (--phones-only, --tablets-only, --desktops-only)
- Parallel execution for fast captures

## Install
\`\`\`bash
npx screenie https://example.com
\`\`\`

## Links
- [Documentation](https://dist-xi-virid.vercel.app)
- [Repository](https://github.com/vmihalis/responsiveness-mcp)"
```

After creating release, monitor the GitHub Actions workflow:
- Go to repository -> Actions tab
- Watch "Publish to npm" workflow
- Verify it completes successfully (green checkmark)

If workflow fails with authentication error, verify:
1. Trusted publisher config on npm matches exactly (repo owner: vmihalis, repo name: responsiveness-mcp, workflow filename: publish.yml)
2. Workflow has `id-token: write` permission
3. No NODE_AUTH_TOKEN is set
  </action>
  <verify>
    gh release view v1.0.0
    gh run list --workflow=publish.yml --limit=1
    - Release exists on GitHub
    - Workflow run shows as completed/success
  </verify>
  <done>
    GitHub release v1.0.0 created and publish workflow triggered successfully.
  </done>
</task>

<task type="auto">
  <name>Task 5: Verify npm publication and provenance</name>
  <files></files>
  <action>
Verify all success criteria are met.

1. Check package metadata:
```bash
npm info screenie
```
Should return package metadata including name, version, description.

2. Check provenance badge on npmjs.com:
- Visit https://www.npmjs.com/package/screenie
- Look for green "Provenance" badge/checkmark
- Click to see provenance details (should link to GitHub Actions build)

3. Test npx execution (from clean environment):
```bash
# Clear npm cache to simulate fresh user
npm cache clean --force

# Test npx works
npx screenie --help
```
Should display help output without errors.

4. Verify provenance with npm audit:
```bash
npm audit signatures
```
Should show screenie has valid signature.

If any verification fails:
- Package not found: Wait 1-2 minutes for npm registry propagation
- No provenance badge: Check GitHub Actions logs for attestation step
- npx fails: Check if postinstall (Playwright) is running correctly
  </action>
  <verify>
    npm info screenie version
    npx screenie --help 2>&1 | head -5
    - npm info returns version "1.0.0"
    - npx screenie --help displays CLI usage
  </verify>
  <done>
    Package live on npm at https://www.npmjs.com/package/screenie with provenance badge, and npx screenie works for new users.
  </done>
</task>

</tasks>

<verification>
Phase 16 is complete when:
- [ ] `package.json` has correct repository URLs (vmihalis/responsiveness-mcp)
- [ ] `.github/workflows/publish.yml` exists with trusted publishing config
- [ ] npm trusted publisher configured on npmjs.com
- [ ] GitHub release v1.0.0 created
- [ ] Publish workflow completed successfully
- [ ] `npm info screenie` returns package metadata
- [ ] Package has provenance badge on npmjs.com
- [ ] `npx screenie --help` works without prior installation
</verification>

<success_criteria>
Requirements satisfied:
- NPM-06: npm provenance signing configured (via trusted publishing + Sigstore)
- NPM-07: Package published to npm registry

Observable truths:
1. `npm info screenie` returns package metadata
2. npm package has provenance badge (visible on npmjs.com)
3. `npx screenie --help` works for new users without prior installation

v2.0 Open Source Release milestone COMPLETE.
</success_criteria>

<output>
After completion, create `.planning/phases/16-publish/16-01-SUMMARY.md`
</output>
