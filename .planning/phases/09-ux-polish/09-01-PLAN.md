---
phase: 09-ux-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/progress.ts
  - src/cli/actions.ts
  - src/cli/__tests__/progress.test.ts
autonomous: true

must_haves:
  truths:
    - "Terminal shows spinner animation during capture"
    - "Progress text updates with device count: Capturing 12/50: iPhone 14 Pro..."
    - "Spinner shows success symbol when all captures succeed"
    - "Spinner shows warning symbol when some captures fail"
    - "Progress works correctly in non-TTY environments (CI)"
  artifacts:
    - path: "src/cli/progress.ts"
      provides: "Spinner wrapper with progress update methods"
      exports: ["createSpinner", "ProgressSpinner"]
      min_lines: 40
    - path: "src/cli/__tests__/progress.test.ts"
      provides: "Unit tests for progress display"
      min_lines: 30
  key_links:
    - from: "src/cli/progress.ts"
      to: "ora"
      via: "import ora from 'ora'"
      pattern: "ora\\("
    - from: "src/cli/actions.ts"
      to: "src/cli/progress.js"
      via: "spinner import"
      pattern: "createSpinner|ProgressSpinner"
---

<objective>
Implement progress indicators using ora spinner for visual feedback during screenshot capture.

Purpose: Replace basic stdout.write progress with animated spinner showing "Capturing 12/50: iPhone 14 Pro..." pattern. Satisfies requirement UX-01.

Output: Progress display utility and updated CLI actions with spinner integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ux-polish/09-RESEARCH.md

# Existing code to modify
@src/cli/actions.ts
@src/utils/progress.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create progress spinner utility</name>
  <files>src/cli/progress.ts</files>
  <action>
Create a spinner wrapper that provides clean progress display methods.

```typescript
// src/cli/progress.ts
import ora, { type Ora } from 'ora';
import pc from 'picocolors';

/**
 * Progress spinner for capture operations.
 * Wraps ora with methods tailored to screenshot capture workflow.
 */
export interface ProgressSpinner {
  /** Start spinner with initial message */
  start(total: number): void;
  /** Update progress with device name and status */
  update(completed: number, total: number, deviceName: string, success: boolean): void;
  /** Complete with success (all succeeded) */
  succeed(count: number): void;
  /** Complete with warning (some failed) */
  warn(succeeded: number, failed: number): void;
  /** Stop spinner (for cleanup) */
  stop(): void;
  /** Check if spinner is currently active */
  isSpinning: boolean;
}

/**
 * Create a progress spinner for capture operations.
 * Automatically handles non-TTY environments (disables animation).
 */
export function createSpinner(): ProgressSpinner {
  let spinner: Ora | null = null;

  return {
    start(total: number): void {
      spinner = ora({
        text: `Starting capture of ${total} devices...`,
        color: 'cyan',
        spinner: 'dots',
      }).start();
    },

    update(completed: number, total: number, deviceName: string, success: boolean): void {
      if (!spinner) return;
      const status = success ? pc.green('OK') : pc.red('FAIL');
      spinner.text = `Capturing ${completed}/${total}: ${deviceName} ${status}`;
    },

    succeed(count: number): void {
      if (!spinner) return;
      spinner.succeed(pc.green(`Captured ${count} devices successfully`));
      spinner = null;
    },

    warn(succeeded: number, failed: number): void {
      if (!spinner) return;
      spinner.stopAndPersist({
        symbol: pc.yellow('!'),
        text: `Captured ${succeeded} devices (${pc.red(`${failed} failed`)})`,
      });
      spinner = null;
    },

    stop(): void {
      if (spinner) {
        spinner.stop();
        spinner = null;
      }
    },

    get isSpinning(): boolean {
      return spinner?.isSpinning ?? false;
    },
  };
}
```

Key points:
- Ora already installed as dependency
- Wraps ora with capture-specific methods
- Handles null spinner state safely
- Uses picocolors for consistent styling
  </action>
  <verify>
`npx tsc --noEmit` passes - progress module compiles without errors
  </verify>
  <done>
src/cli/progress.ts exports createSpinner() returning ProgressSpinner interface with start, update, succeed, warn, stop methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate spinner into actions.ts</name>
  <files>src/cli/actions.ts</files>
  <action>
Update runCapture to use spinner instead of stdout.write.

Changes to make:
1. Import createSpinner from progress.ts
2. Replace `process.stdout.write` progress with spinner.update
3. Use spinner.succeed or spinner.warn based on results
4. Ensure spinner is stopped in error cases

Replace the capture section (approximately lines 55-84):

```typescript
// Add import at top
import { createSpinner } from './progress.js';

// In runCapture, replace the capture loop:

    // 5. Capture each page
    for (const page of pages) {
      const fullUrl = buildFullUrl(baseUrl, page);
      console.log(pc.cyan(`\nCapturing: ${fullUrl}`));

      // Create spinner for this page's captures
      const spinner = createSpinner();
      spinner.start(devices.length);

      const result = await captureAllDevices(
        manager,
        fullUrl,
        devices,
        {
          timeout: defaultConfig.timeout,
          waitBuffer,
        },
        {
          concurrency,
          onProgress: (done, total, res) => {
            spinner.update(done, total, res.deviceName, res.success);
          },
        }
      );

      // Show final spinner state
      if (result.failureCount === 0) {
        spinner.succeed(result.successCount);
      } else {
        spinner.warn(result.successCount, result.failureCount);
      }

      // Rest of the loop remains the same (save, report)
```

Remove the old progress line:
- Delete: `process.stdout.write(`\r  ${done}/${total} ${res.deviceName} ${status}  `);`
- Delete: `process.stdout.write('\r' + ' '.repeat(60) + '\r');`
- Delete: The `const status = res.success ? pc.green('OK') : pc.red('FAIL');` inside onProgress

Keep the `console.log(pc.dim(...))` line for succeeded/failed count as backup info.
  </action>
  <verify>
`npm run build` succeeds and `node dist/cli.js --help` works
  </verify>
  <done>
actions.ts uses createSpinner() for progress display instead of stdout.write, with spinner.update in onProgress callback
  </done>
</task>

<task type="auto">
  <name>Task 3: Add progress utility tests</name>
  <files>src/cli/__tests__/progress.test.ts</files>
  <action>
Create unit tests for the progress spinner utility.

```typescript
// src/cli/__tests__/progress.test.ts
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { createSpinner } from '../progress.js';

describe('progress spinner', () => {
  describe('createSpinner', () => {
    it('returns ProgressSpinner interface', () => {
      const spinner = createSpinner();
      expect(spinner).toHaveProperty('start');
      expect(spinner).toHaveProperty('update');
      expect(spinner).toHaveProperty('succeed');
      expect(spinner).toHaveProperty('warn');
      expect(spinner).toHaveProperty('stop');
      expect(spinner).toHaveProperty('isSpinning');
    });

    it('isSpinning is false initially', () => {
      const spinner = createSpinner();
      expect(spinner.isSpinning).toBe(false);
    });

    it('isSpinning is true after start', () => {
      const spinner = createSpinner();
      spinner.start(10);
      expect(spinner.isSpinning).toBe(true);
      spinner.stop(); // cleanup
    });

    it('isSpinning is false after succeed', () => {
      const spinner = createSpinner();
      spinner.start(10);
      spinner.succeed(10);
      expect(spinner.isSpinning).toBe(false);
    });

    it('isSpinning is false after warn', () => {
      const spinner = createSpinner();
      spinner.start(10);
      spinner.warn(8, 2);
      expect(spinner.isSpinning).toBe(false);
    });

    it('isSpinning is false after stop', () => {
      const spinner = createSpinner();
      spinner.start(10);
      spinner.stop();
      expect(spinner.isSpinning).toBe(false);
    });

    it('update is safe when not started', () => {
      const spinner = createSpinner();
      // Should not throw
      expect(() => spinner.update(1, 10, 'iPhone', true)).not.toThrow();
    });

    it('succeed is safe when not started', () => {
      const spinner = createSpinner();
      // Should not throw
      expect(() => spinner.succeed(10)).not.toThrow();
    });

    it('warn is safe when not started', () => {
      const spinner = createSpinner();
      // Should not throw
      expect(() => spinner.warn(8, 2)).not.toThrow();
    });

    it('stop is safe when not started', () => {
      const spinner = createSpinner();
      // Should not throw
      expect(() => spinner.stop()).not.toThrow();
    });

    it('can be reused after succeed', () => {
      const spinner = createSpinner();
      spinner.start(10);
      spinner.succeed(10);
      // Can start again
      spinner.start(20);
      expect(spinner.isSpinning).toBe(true);
      spinner.stop();
    });
  });
});
```

Tests verify:
- Interface shape
- State tracking (isSpinning)
- Safe handling of methods called without start
- Reusability after completion
  </action>
  <verify>
`npm test -- src/cli/__tests__/progress.test.ts` passes all tests
  </verify>
  <done>
src/cli/__tests__/progress.test.ts has 10+ tests covering spinner interface, state tracking, and safe method handling
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. `npm test -- src/cli/__tests__/progress.test.ts` passes
3. Manual test: `node dist/cli.js https://example.com --phones-only` shows spinner animation (in TTY)
4. Progress updates show "Capturing X/Y: DeviceName OK/FAIL" pattern
</verification>

<success_criteria>
- Spinner animates during capture (visible in terminal)
- Progress text shows count and device name
- Success shows green checkmark with count
- Partial failure shows yellow warning with counts
- All existing CLI tests still pass
- New progress tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-ux-polish/09-01-SUMMARY.md`
</output>
