---
phase: 09-ux-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/cookies.ts
  - src/engine/capturer.ts
  - src/engine/types.ts
  - src/engine/index.ts
  - src/engine/__tests__/cookies.test.ts
autonomous: true

must_haves:
  truths:
    - "Common cookie banners are hidden in screenshots"
    - "OneTrust, Cookiebot, GDPR banners are hidden"
    - "Cookie hiding can be disabled via option"
    - "CSS injection happens after page load"
  artifacts:
    - path: "src/engine/cookies.ts"
      provides: "Cookie banner selectors and hide function"
      exports: ["COOKIE_BANNER_SELECTORS", "hideCookieBanners"]
      min_lines: 60
    - path: "src/engine/__tests__/cookies.test.ts"
      provides: "Unit tests for cookie hiding"
      min_lines: 30
  key_links:
    - from: "src/engine/cookies.ts"
      to: "playwright"
      via: "Page type import"
      pattern: "page\\.addStyleTag"
    - from: "src/engine/capturer.ts"
      to: "src/engine/cookies.js"
      via: "hideCookieBanners import"
      pattern: "hideCookieBanners"
---

<objective>
Implement cookie banner auto-hiding using CSS injection for cleaner screenshots.

Purpose: Hide common cookie consent banners (OneTrust, Cookiebot, GDPR popups) before capture so screenshots show actual page content. Satisfies requirement UX-02.

Output: Cookie hiding utility and integration into capturer.ts with option to disable.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ux-polish/09-RESEARCH.md

# Existing code to modify
@src/engine/capturer.ts
@src/engine/types.ts
@src/engine/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cookie banner hiding module</name>
  <files>src/engine/cookies.ts</files>
  <action>
Create the cookie banner CSS injection utility.

```typescript
// src/engine/cookies.ts
import type { Page } from 'playwright';

/**
 * CSS selectors for common cookie consent banners and overlays.
 * Sources:
 * - "I don't care about cookies" extension
 * - Consent-O-Matic rules
 * - htmlcsstoimage.com blocking guide
 */
export const COOKIE_BANNER_SELECTORS = [
  // === Major CMP Platforms ===
  '#onetrust-consent-sdk',           // OneTrust
  '#onetrust-banner-sdk',            // OneTrust banner
  '#CybotCookiebotDialog',           // Cookiebot
  '#CybotCookiebotDialogBodyLevelButtonLevelOptinAllowAll', // Cookiebot
  '.qc-cmp2-container',              // Quantcast Choice
  '#truste-consent-track',           // TrustArc
  '#truste-consent-button',          // TrustArc
  '#didomi-host',                    // Didomi
  '#didomi-notice',                  // Didomi
  '.osano-cm-window',                // Osano
  '#cmpbox',                         // consentmanager.net
  '#usercentrics-root',              // Usercentrics

  // === Common Generic Patterns ===
  '#cookie-banner',
  '#cookie-notice',
  '#cookie-consent',
  '#cookie-law-info-bar',
  '#cookieNotice',
  '#cookieBanner',
  '.cookie-banner',
  '.cookie-notice',
  '.cookie-consent',
  '.cookie-popup',
  '.cookie-modal',
  '.cookie-overlay',

  // === EU/GDPR Specific ===
  '#eu-cookie-bar',
  '#eucookie',
  '#gdpr-banner',
  '#gdprContainer',
  '.gdpr-banner',
  '.gdpr-popup',

  // === Regional/Framework Specific ===
  '#tarteaucitronRoot',              // Tarteaucitron (French)
  '#cnilCookie',                     // CNIL compliance
  '#cc-notification',                // Cookie Compliance
  '#cc-modal',                       // Cookie Compliance
  '.cc-banner',                      // cookieconsent.js
  '.cc-window',                      // cookieconsent.js
  '.CookieChoiceContainer',          // Google Cookie Choices

  // === Common Class Patterns ===
  '[class*="cookie-consent"]',
  '[class*="cookie-banner"]',
  '[class*="cookie-notice"]',
  '[id*="cookie-consent"]',
  '[id*="cookie-banner"]',
  '[id*="cookie-notice"]',

  // === Overlay/Modal Patterns ===
  '.consent-banner',
  '.consent-overlay',
  '.consent-modal',
  '.privacy-banner',
  '.privacy-notice',
] as const;

/**
 * Build CSS rule to hide elements matching selectors.
 * Uses aggressive hiding: display:none + visibility:hidden + opacity:0
 */
function buildCookieHideCSS(selectors: readonly string[]): string {
  return `${selectors.join(',\n')} {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  pointer-events: none !important;
}`;
}

/**
 * Hide common cookie consent banners on a page via CSS injection.
 * Should be called after page.goto() completes for reliable timing.
 *
 * @param page - Playwright Page instance
 *
 * @example
 * await page.goto(url, { waitUntil: 'networkidle' });
 * await hideCookieBanners(page);
 * const screenshot = await page.screenshot({ fullPage: true });
 */
export async function hideCookieBanners(page: Page): Promise<void> {
  const css = buildCookieHideCSS(COOKIE_BANNER_SELECTORS);
  await page.addStyleTag({ content: css });
}
```

Key points:
- Selectors from research (community-tested patterns)
- Uses `display: none !important` for complete hiding
- Called after navigation for reliable timing
- Const assertion for type safety on selectors array
  </action>
  <verify>
`npx tsc --noEmit` passes - cookies module compiles without errors
  </verify>
  <done>
src/engine/cookies.ts exports COOKIE_BANNER_SELECTORS array and hideCookieBanners(page) function
  </done>
</task>

<task type="auto">
  <name>Task 2: Add hideCookieBanners option and integrate</name>
  <files>src/engine/types.ts, src/engine/capturer.ts, src/engine/index.ts</files>
  <action>
Add option to CaptureOptions and integrate into capturer.

**1. Update types.ts - add to CaptureOptions interface:**

```typescript
// Add to CaptureOptions interface (around line 35-44)
export interface CaptureOptions {
  url: string;
  device: Device;
  timeout: number;
  waitBuffer: number;
  /** Whether to scroll for lazy-loaded content (default: true) */
  scrollForLazy?: boolean;
  /** Max scroll iterations to prevent infinite scroll hangs (default: 10) */
  maxScrollIterations?: number;
  /** Hide common cookie consent banners before capture (default: true) */
  hideCookieBanners?: boolean;
}
```

**2. Update capturer.ts - add cookie hiding after navigation:**

Add import at top:
```typescript
import { hideCookieBanners } from './cookies.js';
```

Update captureScreenshot function to use the option. Add after the waitBuffer timeout (around line 54):

```typescript
    // LOAD-02: Wait buffer after network idle for post-idle rendering
    await page.waitForTimeout(waitBuffer);

    // UX-02: Hide cookie banners before capture (default: true)
    if (options.hideCookieBanners !== false) {
      await hideCookieBanners(page);
    }

    // LOAD-03: Scroll for lazy-loaded content
```

The destructuring at the top should add:
```typescript
  const {
    url,
    device,
    timeout = DEFAULT_TIMEOUT,
    waitBuffer = 500,
    scrollForLazy = true,
    maxScrollIterations = 10,
    hideCookieBanners: shouldHideCookies = true,  // renamed to avoid collision with imported function
  } = options;
```

Then use `shouldHideCookies` in the condition:
```typescript
    if (shouldHideCookies) {
      await hideCookieBanners(page);
    }
```

**3. Update index.ts - add export:**

```typescript
export { hideCookieBanners, COOKIE_BANNER_SELECTORS } from './cookies.js';
```
  </action>
  <verify>
`npm run build` succeeds - all engine modules compile and export correctly
  </verify>
  <done>
CaptureOptions has hideCookieBanners option (default true), capturer.ts calls hideCookieBanners after waitBuffer, engine/index.ts exports cookie utilities
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cookie hiding tests</name>
  <files>src/engine/__tests__/cookies.test.ts</files>
  <action>
Create unit tests for the cookie hiding module.

```typescript
// src/engine/__tests__/cookies.test.ts
import { describe, it, expect, vi, beforeAll, afterAll } from 'vitest';
import { chromium, type Browser, type Page } from 'playwright';
import { COOKIE_BANNER_SELECTORS, hideCookieBanners } from '../cookies.js';

describe('cookie banner hiding', () => {
  describe('COOKIE_BANNER_SELECTORS', () => {
    it('is a non-empty array', () => {
      expect(Array.isArray(COOKIE_BANNER_SELECTORS)).toBe(true);
      expect(COOKIE_BANNER_SELECTORS.length).toBeGreaterThan(0);
    });

    it('includes major CMP platforms', () => {
      const selectors = COOKIE_BANNER_SELECTORS.join(' ');
      expect(selectors).toContain('onetrust');    // OneTrust
      expect(selectors).toContain('Cookiebot');   // Cookiebot
      expect(selectors).toContain('didomi');      // Didomi
      expect(selectors).toContain('truste');      // TrustArc
    });

    it('includes generic cookie patterns', () => {
      expect(COOKIE_BANNER_SELECTORS).toContain('#cookie-banner');
      expect(COOKIE_BANNER_SELECTORS).toContain('.cookie-consent');
      expect(COOKIE_BANNER_SELECTORS).toContain('#gdpr-banner');
    });

    it('includes attribute selectors for flexible matching', () => {
      const hasAttributeSelector = COOKIE_BANNER_SELECTORS.some(s => s.includes('[class*='));
      expect(hasAttributeSelector).toBe(true);
    });

    it('all selectors are valid CSS syntax', () => {
      // Build CSS to verify it's parseable
      const css = COOKIE_BANNER_SELECTORS.join(', ') + ' { display: none; }';
      // If this throws, the selectors have invalid syntax
      expect(() => css).not.toThrow();
    });
  });

  describe('hideCookieBanners', () => {
    let browser: Browser;
    let page: Page;

    beforeAll(async () => {
      browser = await chromium.launch({ headless: true });
    });

    afterAll(async () => {
      await browser.close();
    });

    beforeEach(async () => {
      const context = await browser.newContext();
      page = await context.newPage();
    });

    afterEach(async () => {
      await page.context().close();
    });

    it('injects CSS style tag into page', async () => {
      // Set up minimal HTML page
      await page.setContent('<html><head></head><body><div id="cookie-banner">Banner</div></body></html>');

      // Count style tags before
      const beforeCount = await page.locator('style').count();

      await hideCookieBanners(page);

      // Count style tags after
      const afterCount = await page.locator('style').count();

      expect(afterCount).toBe(beforeCount + 1);
    });

    it('hides elements matching cookie banner selectors', async () => {
      // Set up page with a cookie banner
      await page.setContent(`
        <html>
          <head></head>
          <body>
            <div id="cookie-banner" style="display: block;">Cookie Banner</div>
            <div id="main">Main Content</div>
          </body>
        </html>
      `);

      await hideCookieBanners(page);

      // Check computed style
      const display = await page.locator('#cookie-banner').evaluate(el => {
        return window.getComputedStyle(el).display;
      });

      expect(display).toBe('none');
    });

    it('does not affect non-banner elements', async () => {
      await page.setContent(`
        <html>
          <head></head>
          <body>
            <div id="main" style="display: block;">Main Content</div>
          </body>
        </html>
      `);

      await hideCookieBanners(page);

      const display = await page.locator('#main').evaluate(el => {
        return window.getComputedStyle(el).display;
      });

      expect(display).toBe('block');
    });

    it('handles OneTrust banner', async () => {
      await page.setContent(`
        <html>
          <body>
            <div id="onetrust-consent-sdk" style="display: block;">OneTrust</div>
          </body>
        </html>
      `);

      await hideCookieBanners(page);

      const display = await page.locator('#onetrust-consent-sdk').evaluate(el => {
        return window.getComputedStyle(el).display;
      });

      expect(display).toBe('none');
    });

    it('handles Cookiebot banner', async () => {
      await page.setContent(`
        <html>
          <body>
            <div id="CybotCookiebotDialog" style="display: block;">Cookiebot</div>
          </body>
        </html>
      `);

      await hideCookieBanners(page);

      const display = await page.locator('#CybotCookiebotDialog').evaluate(el => {
        return window.getComputedStyle(el).display;
      });

      expect(display).toBe('none');
    });

    it('handles class-based cookie banners', async () => {
      await page.setContent(`
        <html>
          <body>
            <div class="cookie-consent-wrapper" style="display: block;">Cookie Consent</div>
          </body>
        </html>
      `);

      await hideCookieBanners(page);

      // Uses attribute selector [class*="cookie-consent"]
      const display = await page.locator('.cookie-consent-wrapper').evaluate(el => {
        return window.getComputedStyle(el).display;
      });

      expect(display).toBe('none');
    });
  });
});
```

Tests verify:
- Selector array validity
- Major CMP coverage
- CSS injection works
- Elements are actually hidden
- Non-banner elements unaffected
  </action>
  <verify>
`npm test -- src/engine/__tests__/cookies.test.ts` passes all tests
  </verify>
  <done>
src/engine/__tests__/cookies.test.ts has 10+ tests covering selector array, CSS injection, and element hiding for various banner types
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. `npm test -- src/engine/__tests__/cookies.test.ts` passes
3. All existing engine tests still pass: `npm test -- src/engine`
4. Cookie hiding is enabled by default in captureScreenshot
</verification>

<success_criteria>
- COOKIE_BANNER_SELECTORS covers major CMPs (OneTrust, Cookiebot, Didomi, etc.)
- hideCookieBanners injects CSS to hide matching elements
- captureScreenshot calls hideCookieBanners by default
- Option allows disabling cookie hiding
- Cookie tests pass
- Existing capturer tests unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/09-ux-polish/09-02-SUMMARY.md`
</output>
