---
phase: 04-page-loading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/types.ts
  - src/engine/capturer.ts
autonomous: true

must_haves:
  truths:
    - "Screenshots wait configurable buffer after networkidle before capture"
    - "CSS animations are disabled in screenshots"
    - "Timeout budget accounts for buffer time"
  artifacts:
    - path: "src/engine/types.ts"
      provides: "Extended CaptureOptions with scrollForLazy, maxScrollIterations"
      contains: "scrollForLazy"
    - path: "src/engine/capturer.ts"
      provides: "captureScreenshot with waitBuffer and animation disabling"
      contains: "animations: 'disabled'"
  key_links:
    - from: "src/engine/capturer.ts"
      to: "page.waitForTimeout"
      via: "waitBuffer parameter"
      pattern: "waitForTimeout.*waitBuffer"
    - from: "src/engine/capturer.ts"
      to: "page.screenshot"
      via: "animations option"
      pattern: "animations.*disabled"
---

<objective>
Enhance captureScreenshot to use wait buffer and disable CSS animations

Purpose: Implement LOAD-02 (post-networkidle buffer) and SHOT-03 (animation disabling) for consistent screenshots
Output: Updated capturer.ts with waitBuffer usage and animations: 'disabled' option
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-page-loading/04-RESEARCH.md

# Relevant source files
@src/engine/types.ts
@src/engine/capturer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend CaptureOptions and implement waitBuffer + animations</name>
  <files>src/engine/types.ts, src/engine/capturer.ts</files>
  <action>
1. In src/engine/types.ts, extend CaptureOptions interface:
   - Keep existing: url, device, timeout, waitBuffer
   - Add: scrollForLazy?: boolean (default true in implementation)
   - Add: maxScrollIterations?: number (default 10 in implementation)

2. In src/engine/capturer.ts:
   - Extract waitBuffer from options (default 500)
   - After page.goto networkidle, add: await page.waitForTimeout(waitBuffer)
   - Update screenshot call to include: animations: 'disabled'
   - Adjust timeout budget: 70% navigation, 15% buffer+scroll, 15% screenshot

Implementation notes:
- waitBuffer already exists in CaptureOptions but is unused - start using it
- animations: 'disabled' is a Playwright screenshot option that stops CSS animations/transitions
- Keep the existing error handling pattern (return error result, don't throw)
  </action>
  <verify>
1. TypeScript compiles: `npm run build`
2. Check that capturer.ts includes waitForTimeout(waitBuffer) call
3. Check that screenshot options include animations: 'disabled'
  </verify>
  <done>
- CaptureOptions includes scrollForLazy and maxScrollIterations optional fields
- captureScreenshot uses waitBuffer parameter after networkidle
- Screenshot uses animations: 'disabled' option
- Build passes with no type errors
  </done>
</task>

</tasks>

<verification>
- `npm run build` compiles without errors
- grep -q "waitForTimeout" src/engine/capturer.ts returns match
- grep -q "animations.*disabled" src/engine/capturer.ts returns match
</verification>

<success_criteria>
1. CaptureOptions extended with scrollForLazy and maxScrollIterations
2. waitBuffer is used (page.waitForTimeout called after networkidle)
3. animations: 'disabled' in screenshot options
4. Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-page-loading/04-01-SUMMARY.md`
</output>
