---
phase: 04-page-loading
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - src/engine/capturer.ts
autonomous: true

must_haves:
  truths:
    - "captureScreenshot scrolls for lazy content when scrollForLazy is true"
    - "captureScreenshot skips scrolling when scrollForLazy is false"
    - "Timeout budget includes scroll phase"
  artifacts:
    - path: "src/engine/capturer.ts"
      provides: "Integrated scroll-for-lazy into capture flow"
      contains: "scrollForLazyContent"
  key_links:
    - from: "src/engine/capturer.ts"
      to: "src/engine/scroll.ts"
      via: "import and call scrollForLazyContent"
      pattern: "import.*scrollForLazyContent"
---

<objective>
Integrate scroll-for-lazy into captureScreenshot function

Purpose: Wire the scrollForLazyContent helper into the main capture flow, completing LOAD-03
Output: Updated capturer.ts that scrolls for lazy content before taking screenshot
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-page-loading/04-RESEARCH.md

# Prior plan summaries (if needed for integration context)
@.planning/phases/04-page-loading/04-01-SUMMARY.md
@.planning/phases/04-page-loading/04-02-SUMMARY.md

# Relevant source files
@src/engine/capturer.ts
@src/engine/scroll.ts
@src/engine/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate scrollForLazyContent into captureScreenshot</name>
  <files>src/engine/capturer.ts</files>
  <action>
Update src/engine/capturer.ts to integrate the scroll helper:

1. Add import at top:
   ```typescript
   import { scrollForLazyContent } from './scroll.js';
   ```

2. Extract new options with defaults:
   ```typescript
   const {
     url,
     device,
     timeout = DEFAULT_TIMEOUT,
     waitBuffer = 500,
     scrollForLazy = true,      // Default: scroll for lazy content
     maxScrollIterations = 10,  // Default: max 10 scroll passes
   } = options;
   ```

3. Adjust timeout budget split (update from current 80/20):
   ```typescript
   // Split timeout: 60% navigation, 25% scroll+buffer, 15% screenshot
   const navigationTimeout = Math.floor(timeout * 0.6);
   const scrollTimeout = Math.floor(timeout * 0.25);
   const screenshotTimeout = Math.floor(timeout * 0.15);
   ```

4. After waitBuffer, add scroll call (before screenshot):
   ```typescript
   // LOAD-03: Scroll for lazy content
   if (scrollForLazy) {
     await scrollForLazyContent(page, maxScrollIterations, scrollTimeout);
   }
   ```

5. Update function JSDoc to document LOAD-02, LOAD-03, SHOT-03:
   - LOAD-02: Wait buffer after networkidle
   - LOAD-03: Scroll for lazy content
   - SHOT-03: Animation disabling

Complete flow after changes:
1. Navigate with networkidle (LOAD-01)
2. Wait buffer (LOAD-02) - from 04-01
3. Scroll for lazy content (LOAD-03) - this task
4. Screenshot with animations disabled (SHOT-01, SHOT-03) - from 04-01
  </action>
  <verify>
1. npm run build passes
2. grep "scrollForLazyContent" src/engine/capturer.ts shows import and call
3. grep "scrollForLazy" src/engine/capturer.ts shows option extraction
  </verify>
  <done>
- capturer.ts imports scrollForLazyContent from scroll.js
- captureScreenshot extracts scrollForLazy and maxScrollIterations from options
- Scroll is called when scrollForLazy is true (default)
- Timeout budget adjusted to include scroll phase
- Build passes
  </done>
</task>

</tasks>

<verification>
- `npm run build` compiles without errors
- `grep -q "import.*scrollForLazyContent" src/engine/capturer.ts` returns match
- `grep -q "if (scrollForLazy)" src/engine/capturer.ts` returns match
</verification>

<success_criteria>
1. scrollForLazyContent imported and called in captureScreenshot
2. scrollForLazy option controls whether scrolling happens (default true)
3. Timeout budget accounts for scroll phase
4. Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-page-loading/04-03-SUMMARY.md`
</output>
