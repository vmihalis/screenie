---
phase: 2
plan: 4
wave: 2
depends_on: [02-01-PLAN.md, 02-02-PLAN.md, 02-03-PLAN.md]
files_modified:
  - src/devices/registry.ts
  - package.json
  - src/devices/devices.test.ts
autonomous: true
---

# Plan 4: Registry Integration and Unit Tests

<objective>
Update registry.ts to import all device data files and combine them. Add Vitest as test framework and create comprehensive unit tests verifying the device registry meets all success criteria.
</objective>

<context>
Device data files exist:
- src/devices/phones.ts (exports `phones`)
- src/devices/tablets.ts (exports `tablets`)
- src/devices/desktops.ts (exports `desktops`)

Current registry.ts has empty placeholder array and stub functions.
Project uses ESM with .js extension imports.
TypeScript has noUncheckedIndexedAccess enabled (extra strict).
</context>

<tasks>
<task id="1">
Add Vitest to package.json devDependencies and add test script:
```json
{
  "scripts": {
    "test": "vitest run",
    "test:watch": "vitest"
  },
  "devDependencies": {
    "vitest": "^2.0.0"
  }
}
```
Run npm install after updating package.json.
</task>

<task id="2">
Update src/devices/registry.ts to:
- Import phones from './phones.js'
- Import tablets from './tablets.js'
- Import desktops from './desktops.js'
- Combine into single devices array: [...phones, ...tablets, ...desktops]
- Update getDevices() to return the combined array
- Ensure getDevicesByCategory() filters correctly
</task>

<task id="3">
Create src/devices/devices.test.ts with comprehensive tests:

```typescript
import { describe, it, expect } from 'vitest';
import { getDevices, getDevicesByCategory } from './index.js';
import type { Device, DeviceCategory } from './types.js';

describe('Device Registry', () => {
  describe('getDevices()', () => {
    it('returns 50+ devices', () => {
      const devices = getDevices();
      expect(devices.length).toBeGreaterThanOrEqual(50);
    });

    it('each device has required properties', () => {
      const devices = getDevices();
      for (const device of devices) {
        expect(device).toHaveProperty('name');
        expect(device).toHaveProperty('width');
        expect(device).toHaveProperty('height');
        expect(device).toHaveProperty('deviceScaleFactor');
        expect(device).toHaveProperty('category');
        expect(typeof device.name).toBe('string');
        expect(device.width).toBeGreaterThan(0);
        expect(device.height).toBeGreaterThan(0);
        expect(device.deviceScaleFactor).toBeGreaterThanOrEqual(1);
      }
    });

    it('includes latest iPhone models', () => {
      const devices = getDevices();
      const names = devices.map(d => d.name);
      expect(names.some(n => n.includes('iPhone 15'))).toBe(true);
      expect(names.some(n => n.includes('iPhone 16'))).toBe(true);
    });

    it('includes Pixel 8', () => {
      const devices = getDevices();
      const names = devices.map(d => d.name);
      expect(names.some(n => n.includes('Pixel 8'))).toBe(true);
    });

    it('includes Galaxy S24', () => {
      const devices = getDevices();
      const names = devices.map(d => d.name);
      expect(names.some(n => n.includes('Galaxy S24'))).toBe(true);
    });
  });

  describe('getDevicesByCategory()', () => {
    it('returns 15+ phones', () => {
      const phones = getDevicesByCategory('phones');
      expect(phones.length).toBeGreaterThanOrEqual(15);
      expect(phones.every(d => d.category === 'phones')).toBe(true);
    });

    it('returns 10+ tablets', () => {
      const tablets = getDevicesByCategory('tablets');
      expect(tablets.length).toBeGreaterThanOrEqual(10);
      expect(tablets.every(d => d.category === 'tablets')).toBe(true);
    });

    it('returns 18+ desktops/laptops', () => {
      const desktops = getDevicesByCategory('pc-laptops');
      expect(desktops.length).toBeGreaterThanOrEqual(18);
      expect(desktops.every(d => d.category === 'pc-laptops')).toBe(true);
    });

    it('filters only matching category', () => {
      const phones = getDevicesByCategory('phones');
      const tablets = getDevicesByCategory('tablets');
      const desktops = getDevicesByCategory('pc-laptops');

      // No overlap between categories
      const phoneNames = new Set(phones.map(d => d.name));
      expect(tablets.every(d => !phoneNames.has(d.name))).toBe(true);
      expect(desktops.every(d => !phoneNames.has(d.name))).toBe(true);
    });
  });

  describe('device data quality', () => {
    it('device names include dimensions', () => {
      const devices = getDevices();
      for (const device of devices) {
        expect(device.name).toMatch(/\(\d+x\d+\)$/);
      }
    });

    it('deviceScaleFactor is within valid range (1-4)', () => {
      const devices = getDevices();
      for (const device of devices) {
        expect(device.deviceScaleFactor).toBeGreaterThanOrEqual(1);
        expect(device.deviceScaleFactor).toBeLessThanOrEqual(4);
      }
    });
  });
});
```
</task>

<task id="4">
Run `npm test` to verify all tests pass.
</task>
</tasks>

<verification>
- [ ] Vitest added to devDependencies
- [ ] npm run test script added to package.json
- [ ] registry.ts imports from phones.ts, tablets.ts, desktops.ts
- [ ] getDevices() returns combined array of 50+ devices
- [ ] getDevicesByCategory('phones') returns only phones
- [ ] devices.test.ts exists with comprehensive tests
- [ ] All tests pass with `npm test`
</verification>

<must_haves>
- Registry contains 50+ devices total
- 15+ phones, 10+ tablets, 18+ desktops/laptops
- getDevices() returns all devices
- getDevicesByCategory() filters correctly by category
- Includes latest models: iPhone 15/16, Pixel 8, Galaxy S24
- All tests pass
- Each device has name, width, height, deviceScaleFactor, category
</must_haves>
