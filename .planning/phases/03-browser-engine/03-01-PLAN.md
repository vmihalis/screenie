---
phase: 03-browser-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/types.ts
  - src/engine/browser.ts
  - src/engine/index.ts
autonomous: true

must_haves:
  truths:
    - "BrowserManager can launch a browser instance"
    - "BrowserManager can create isolated contexts for devices"
    - "BrowserManager closes cleanly without orphan processes"
    - "Process handles SIGINT/SIGTERM gracefully"
  artifacts:
    - path: "src/engine/browser.ts"
      provides: "BrowserManager class with context management"
      exports: ["BrowserManager"]
      min_lines: 60
    - path: "src/engine/types.ts"
      provides: "Engine type definitions"
      contains: "BrowserManagerOptions"
    - path: "src/engine/index.ts"
      provides: "Public exports"
      exports: ["BrowserManager"]
  key_links:
    - from: "src/engine/browser.ts"
      to: "playwright"
      via: "chromium.launch()"
      pattern: "chromium\\.launch"
    - from: "src/engine/browser.ts"
      to: "browser.newContext()"
      via: "device emulation"
      pattern: "newContext\\("
---

<objective>
Enhance BrowserManager class and add engine types for Playwright browser management.

Purpose: Establish the foundation for screenshot capture - a singleton browser that creates isolated contexts per device, with graceful shutdown handling.

Output: Enhanced BrowserManager with createContext(), shutdown handlers, and supporting types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-browser-engine/03-RESEARCH.md

@src/engine/browser.ts
@src/engine/types.ts
@src/devices/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add engine types for browser management</name>
  <files>src/engine/types.ts</files>
  <action>
Enhance src/engine/types.ts to add browser management types:

1. Add `BrowserManagerOptions` interface:
   - `headless?: boolean` (default true)

2. Add `DEFAULT_TIMEOUT` constant:
   - Value: 30000 (30 seconds per LOAD-04)

3. Add `ContextOptions` interface for device context creation:
   - `viewport: { width: number; height: number }`
   - `deviceScaleFactor: number`
   - `userAgent?: string`
   - `isMobile?: boolean`
   - `hasTouch?: boolean`

Keep existing CaptureOptions and ScreenshotResult interfaces unchanged.
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Grep for `BrowserManagerOptions` and `DEFAULT_TIMEOUT` in the file.
  </verify>
  <done>
types.ts exports BrowserManagerOptions, ContextOptions, DEFAULT_TIMEOUT alongside existing types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance BrowserManager with context management and graceful shutdown</name>
  <files>src/engine/browser.ts</files>
  <action>
Rewrite src/engine/browser.ts to implement the single browser, multiple contexts pattern:

1. Import types:
   ```typescript
   import { chromium, Browser, BrowserContext } from 'playwright';
   import type { Device } from '../devices/types.js';
   import type { BrowserManagerOptions, ContextOptions } from './types.js';
   import { DEFAULT_TIMEOUT } from './types.js';
   ```

2. BrowserManager class with:
   - Private `browser: Browser | null = null`
   - Private `activeContexts: Set<BrowserContext> = new Set()`
   - Private `shutdownHandlersRegistered = false`

3. `async launch(options?: BrowserManagerOptions): Promise<Browser>`:
   - If already launched, return existing browser
   - Launch chromium with `headless: options?.headless ?? true`
   - Call `setupShutdownHandlers()` if not already registered
   - Return browser

4. `async createContext(device: Device): Promise<BrowserContext>`:
   - Call `launch()` to ensure browser is running
   - Build context options from device:
     - viewport: { width: device.width, height: device.height }
     - deviceScaleFactor: device.deviceScaleFactor
     - userAgent: device.userAgent (if present)
     - isMobile: device.category === 'phones'
     - hasTouch: device.category !== 'pc-laptops'
   - Create context with `browser.newContext(options)`
   - Add context to activeContexts Set
   - Set default navigation timeout: `context.setDefaultNavigationTimeout(DEFAULT_TIMEOUT)`
   - Return context

5. `async closeContext(context: BrowserContext): Promise<void>`:
   - If context is in activeContexts, close it and remove from Set
   - Safe to call multiple times (idempotent)

6. `async close(): Promise<void>`:
   - Close all active contexts first (iterate, close each)
   - Clear activeContexts Set
   - If browser exists, close it and set to null
   - Remove shutdown handlers

7. `isLaunched(): boolean`:
   - Return `this.browser !== null`

8. Private `setupShutdownHandlers()`:
   - Define cleanup function that calls `this.close()` then `process.exit(0)`
   - Register on 'SIGINT' and 'SIGTERM'
   - Set `shutdownHandlersRegistered = true`
   - Store handler references for removal in close()

9. Remove the standalone `launchBrowser()` function - BrowserManager is the public API.

Important: Use ESM imports with .js extensions. Handle async cleanup properly.
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Run `npm run build` - should produce dist/engine/browser.js.
  </verify>
  <done>
BrowserManager class has launch(), createContext(device), closeContext(), close(), isLaunched() methods.
Shutdown handlers registered for SIGINT/SIGTERM.
Context options correctly set isMobile/hasTouch based on device category.
  </done>
</task>

<task type="auto">
  <name>Task 3: Export public API from engine index</name>
  <files>src/engine/index.ts</files>
  <action>
Update src/engine/index.ts to export the public API:

```typescript
// Types
export type {
  CaptureOptions,
  ScreenshotResult,
  BrowserManagerOptions,
  ContextOptions,
} from './types.js';

export { DEFAULT_TIMEOUT } from './types.js';

// Classes
export { BrowserManager } from './browser.js';

// Functions (capturer will be added in next plan)
export { captureScreenshot } from './capturer.js';
```

This establishes the public interface for the engine module.
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Run `npm run build` - should succeed.
  </verify>
  <done>
src/engine/index.ts exports all public types, constants, classes, and functions from the engine module.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles: `npx tsc --noEmit` succeeds
2. Build succeeds: `npm run build` produces dist/
3. Exports work: `grep -r "export" src/engine/index.ts` shows all exports
4. BrowserManager is complete: All methods documented in action exist in browser.ts
</verification>

<success_criteria>
- BrowserManager.launch() creates a browser instance
- BrowserManager.createContext(device) creates isolated context with device emulation
- BrowserManager.close() cleans up all contexts and browser
- SIGINT/SIGTERM handlers registered for graceful shutdown
- All types exported from src/engine/index.ts
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-browser-engine/03-01-SUMMARY.md`
</output>
