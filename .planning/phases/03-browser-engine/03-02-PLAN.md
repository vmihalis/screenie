---
phase: 03-browser-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/engine/capturer.ts
autonomous: true

must_haves:
  truths:
    - "captureScreenshot navigates to URL and waits for network idle"
    - "captureScreenshot captures full-page screenshot (entire scrollable content)"
    - "captureScreenshot times out after 30s on slow pages"
    - "captureScreenshot returns Buffer on success"
    - "captureScreenshot returns error message on failure"
    - "Context is always closed after capture (success or failure)"
  artifacts:
    - path: "src/engine/capturer.ts"
      provides: "Screenshot capture function"
      exports: ["captureScreenshot"]
      min_lines: 50
  key_links:
    - from: "src/engine/capturer.ts"
      to: "BrowserManager.createContext()"
      via: "context creation for device"
      pattern: "manager\\.createContext"
    - from: "src/engine/capturer.ts"
      to: "page.goto()"
      via: "navigation with networkidle"
      pattern: "goto.*networkidle"
    - from: "src/engine/capturer.ts"
      to: "page.screenshot()"
      via: "full-page capture"
      pattern: "screenshot.*fullPage.*true"
---

<objective>
Implement the captureScreenshot function that captures full-page screenshots with network idle wait and timeout handling.

Purpose: This is the core capture logic that satisfies SHOT-01 (full-page), LOAD-01 (network idle), and LOAD-04 (30s timeout).

Output: Working captureScreenshot function that returns ScreenshotResult with Buffer or error.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-browser-engine/03-RESEARCH.md
@.planning/phases/03-browser-engine/03-01-SUMMARY.md

@src/engine/types.ts
@src/engine/browser.ts
@src/devices/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement captureScreenshot function</name>
  <files>src/engine/capturer.ts</files>
  <action>
Replace the placeholder in src/engine/capturer.ts with the full implementation:

1. Imports:
   ```typescript
   import type { CaptureOptions, ScreenshotResult } from './types.js';
   import { DEFAULT_TIMEOUT } from './types.js';
   import { BrowserManager } from './browser.js';
   ```

2. `captureScreenshot(manager: BrowserManager, options: CaptureOptions): Promise<ScreenshotResult>`:

   **Signature change:** Add `manager: BrowserManager` as first parameter. The caller provides the manager instance (allows reuse across captures).

   **Timeout budget split** (from research):
   - Total timeout: `options.timeout` (default DEFAULT_TIMEOUT = 30000)
   - Navigation timeout: 80% of total (24000ms for 30s)
   - Screenshot timeout: 20% of total (6000ms for 30s)

   **Implementation:**
   ```typescript
   export async function captureScreenshot(
     manager: BrowserManager,
     options: CaptureOptions
   ): Promise<ScreenshotResult> {
     const { url, device, timeout = DEFAULT_TIMEOUT } = options;

     // Split timeout budget: 80% navigation, 20% screenshot
     const navigationTimeout = Math.floor(timeout * 0.8);
     const screenshotTimeout = Math.floor(timeout * 0.2);

     const context = await manager.createContext(device);

     try {
       const page = await context.newPage();

       // Navigate with network idle wait (LOAD-01)
       await page.goto(url, {
         waitUntil: 'networkidle',
         timeout: navigationTimeout,
       });

       // Capture full-page screenshot (SHOT-01)
       const buffer = await page.screenshot({
         fullPage: true,
         type: 'png',
         scale: 'css',  // Consistent file sizes across DPRs
         timeout: screenshotTimeout,
       });

       return {
         success: true,
         deviceName: device.name,
         buffer,
       };
     } catch (error) {
       // Return error result instead of throwing
       const message = error instanceof Error ? error.message : String(error);
       return {
         success: false,
         deviceName: device.name,
         error: message,
       };
     } finally {
       // Always close context to prevent resource leaks
       await manager.closeContext(context);
     }
   }
   ```

   **Key behaviors:**
   - Uses manager.createContext(device) for isolation
   - Waits for networkidle before capture (LOAD-01)
   - Full-page screenshot captures entire scrollable content (SHOT-01)
   - Split timeout enforces 30s max (LOAD-04)
   - Context always closed in finally block
   - Errors caught and returned in result (not thrown)
   - Uses `scale: 'css'` for consistent file sizes regardless of device DPR

3. Do NOT change the CaptureOptions interface - the manager is passed separately.
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile without errors.
Run `npm run build` - should succeed.

Manual verification (optional):
```typescript
// Quick test script
import { BrowserManager, captureScreenshot } from './dist/engine/index.js';
import { getDevices } from './dist/devices/index.js';

const manager = new BrowserManager();
const devices = getDevices();
const phone = devices.find(d => d.category === 'phones');
const result = await captureScreenshot(manager, {
  url: 'https://example.com',
  device: phone,
  timeout: 30000,
  waitBuffer: 500,
});
console.log(result.success, result.buffer?.length);
await manager.close();
```
  </verify>
  <done>
captureScreenshot function:
- Takes BrowserManager and CaptureOptions
- Creates device context with proper emulation
- Navigates with networkidle wait
- Captures full-page screenshot
- Returns ScreenshotResult with buffer or error
- Always closes context in finally block
  </done>
</task>

<task type="auto">
  <name>Task 2: Update index.ts export with new signature</name>
  <files>src/engine/index.ts</files>
  <action>
Verify src/engine/index.ts already exports captureScreenshot. If the export exists from Plan 01, no changes needed.

If needed, ensure this line is present:
```typescript
export { captureScreenshot } from './capturer.js';
```

The function signature change (adding manager parameter) doesn't affect the export.
  </action>
  <verify>
`grep "captureScreenshot" src/engine/index.ts` shows the export.
`npx tsc --noEmit` compiles without errors.
  </verify>
  <done>
captureScreenshot exported from src/engine/index.ts.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles: `npx tsc --noEmit` succeeds
2. Build succeeds: `npm run build` produces dist/
3. Function exported: `grep "captureScreenshot" src/engine/index.ts`
4. Key patterns present in capturer.ts:
   - `createContext(device)` - uses manager for context
   - `waitUntil: 'networkidle'` - network idle wait
   - `fullPage: true` - full-page capture
   - `finally { await manager.closeContext` - cleanup
</verification>

<success_criteria>
- captureScreenshot function implemented with correct signature
- Navigation waits for network idle (LOAD-01)
- Screenshot captures full page (SHOT-01)
- Timeout split: 80% navigation, 20% screenshot (LOAD-04)
- Context always closed in finally block
- Errors returned in ScreenshotResult, not thrown
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-browser-engine/03-02-SUMMARY.md`
</output>
