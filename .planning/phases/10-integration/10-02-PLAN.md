---
phase: 10-integration
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - package.json
  - src/cli/__tests__/e2e.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Full pipeline works: CLI -> devices -> capture -> output -> report"
    - "Exit code 0 on success"
    - "Exit code 2 on validation error (invalid URL)"
    - "Report file exists after successful capture"
    - "Screenshots organized in category folders"
  artifacts:
    - path: "package.json"
      provides: "execa and strip-ansi dev dependencies"
      contains: "execa"
    - path: "src/cli/__tests__/e2e.test.ts"
      provides: "End-to-end CLI tests"
      min_lines: 80
  key_links:
    - from: "src/cli/__tests__/e2e.test.ts"
      to: "dist/cli.js"
      via: "execa subprocess invocation"
      pattern: "execa.*dist/cli\\.js"
---

<objective>
Create end-to-end tests for the complete CLI pipeline

Purpose: Validate the full integration works as a subprocess, matching how users will invoke the tool
Output: E2E test suite that invokes the built CLI and verifies output, exit codes, and file generation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-integration/10-RESEARCH.md
@.planning/phases/10-integration/10-01-SUMMARY.md

# Existing test patterns
@src/cli/__tests__/commands.test.ts
@src/output/__tests__/organizer.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install E2E test dependencies</name>
  <files>package.json</files>
  <action>
    Install execa and strip-ansi as dev dependencies:
    ```bash
    npm install -D execa strip-ansi
    ```

    These are standard tools for CLI subprocess testing:
    - execa: Modern subprocess execution with promise API
    - strip-ansi: Remove ANSI escape codes for clean assertions

    Note: Both are ESM-only (v7+ for execa, v7+ for strip-ansi), matching our project setup.
  </action>
  <verify>
    - npm ls execa shows execa installed
    - npm ls strip-ansi shows strip-ansi installed
  </verify>
  <done>
    - execa in devDependencies
    - strip-ansi in devDependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create E2E test file</name>
  <files>src/cli/__tests__/e2e.test.ts</files>
  <action>
    Create src/cli/__tests__/e2e.test.ts with the following structure:

    ```typescript
    import { describe, it, expect, beforeAll, afterAll } from 'vitest';
    import { execa } from 'execa';
    import stripAnsi from 'strip-ansi';
    import { existsSync, rmSync, readdirSync } from 'node:fs';
    import { join } from 'node:path';

    /**
     * End-to-end tests that invoke the built CLI as a subprocess
     * These tests verify the full pipeline works correctly
     */
    describe('CLI E2E', () => {
      const testOutputDir = '.test-output-e2e';
      const cliPath = './dist/cli.js';

      // Helper to invoke CLI and capture result
      async function invokeCli(args: string[]): Promise<{
        exitCode: number;
        stdout: string;
        stderr: string;
      }> {
        try {
          const result = await execa('node', [cliPath, ...args]);
          return {
            exitCode: result.exitCode,
            stdout: stripAnsi(result.stdout),
            stderr: stripAnsi(result.stderr),
          };
        } catch (error) {
          // execa throws on non-zero exit
          const execaError = error as {
            exitCode?: number;
            stdout?: string;
            stderr?: string;
          };
          return {
            exitCode: execaError.exitCode ?? 1,
            stdout: stripAnsi(execaError.stdout ?? ''),
            stderr: stripAnsi(execaError.stderr ?? ''),
          };
        }
      }

      beforeAll(async () => {
        // Ensure CLI is built
        await execa('npm', ['run', 'build']);

        // Clean up any previous test output
        if (existsSync(testOutputDir)) {
          rmSync(testOutputDir, { recursive: true, force: true });
        }
      });

      afterAll(() => {
        // Clean up test output
        if (existsSync(testOutputDir)) {
          rmSync(testOutputDir, { recursive: true, force: true });
        }
      });

      describe('help and version', () => {
        it('shows help with --help', async () => {
          const result = await invokeCli(['--help']);

          expect(result.exitCode).toBe(0);
          expect(result.stdout).toContain('responsive-capture');
          expect(result.stdout).toContain('<url>');
          expect(result.stdout).toContain('--no-open');
        });

        it('shows version with --version', async () => {
          const result = await invokeCli(['--version']);

          expect(result.exitCode).toBe(0);
          expect(result.stdout).toContain('1.0.0');
        });
      });

      describe('validation errors', () => {
        it('returns exit code 2 for missing URL', async () => {
          const result = await invokeCli([]);

          expect(result.exitCode).toBe(1); // Commander exits 1 for missing required arg
          expect(result.stderr).toContain('url');
        });

        it('returns exit code 2 for invalid URL', async () => {
          const result = await invokeCli(['invalid-url']);

          expect(result.exitCode).toBe(2);
          expect(result.stderr).toContain('Invalid');
        });

        it('returns exit code 2 for invalid concurrency', async () => {
          const result = await invokeCli([
            'https://example.com',
            '--concurrency',
            '100',
          ]);

          expect(result.exitCode).toBe(2);
          expect(result.stderr).toContain('Concurrency');
        });
      });

      describe('full pipeline', () => {
        it(
          'captures screenshots and generates report',
          async () => {
            // Use example.com (stable, fast) with minimal devices for speed
            const result = await invokeCli([
              'https://example.com',
              '--phones-only',
              '--no-open', // Don't open browser in tests
              '-o',
              testOutputDir,
            ]);

            expect(result.exitCode).toBe(0);
            expect(result.stdout).toContain('Report saved');
            expect(result.stdout).toContain('Done in');

            // Verify output structure
            expect(existsSync(testOutputDir)).toBe(true);

            // Find the timestamped folder
            const dirs = readdirSync(testOutputDir);
            expect(dirs.length).toBeGreaterThanOrEqual(1);

            const timestampDir = dirs[0];
            if (!timestampDir) {
              throw new Error('No timestamp directory created');
            }
            const outputPath = join(testOutputDir, timestampDir);

            // Verify category folders exist
            expect(existsSync(join(outputPath, 'phones'))).toBe(true);

            // Verify report exists
            expect(existsSync(join(outputPath, 'report.html'))).toBe(true);

            // Verify some screenshots exist in phones folder
            const phonesDir = join(outputPath, 'phones');
            const screenshots = readdirSync(phonesDir).filter((f) =>
              f.endsWith('.png')
            );
            expect(screenshots.length).toBeGreaterThan(0);
          },
          { timeout: 120000 } // 2 min timeout for real network capture
        );
      });

      describe('device filtering', () => {
        it('respects --phones-only flag', async () => {
          const outputDir = join(testOutputDir, 'phones-test');

          const result = await invokeCli([
            'https://example.com',
            '--phones-only',
            '--no-open',
            '-o',
            outputDir,
          ]);

          expect(result.exitCode).toBe(0);

          // Find timestamp folder
          const dirs = readdirSync(outputDir);
          const timestampDir = dirs[0];
          if (!timestampDir) {
            throw new Error('No timestamp directory created');
          }
          const outputPath = join(outputDir, timestampDir);

          // Only phones folder should have content
          expect(existsSync(join(outputPath, 'phones'))).toBe(true);

          // tablets and pc-laptops should be empty or not have screenshots
          const tabletsDir = join(outputPath, 'tablets');
          const desktopsDir = join(outputPath, 'pc-laptops');

          if (existsSync(tabletsDir)) {
            const tabletFiles = readdirSync(tabletsDir).filter((f) =>
              f.endsWith('.png')
            );
            expect(tabletFiles.length).toBe(0);
          }

          if (existsSync(desktopsDir)) {
            const desktopFiles = readdirSync(desktopsDir).filter((f) =>
              f.endsWith('.png')
            );
            expect(desktopFiles.length).toBe(0);
          }
        }, { timeout: 120000 });
      });
    });
    ```

    Key points:
    - Uses execa with reject: false implicitly via try/catch for non-zero exits
    - Uses strip-ansi to clean output for assertions
    - Tests help/version (fast), validation errors (fast), full pipeline (slow but essential)
    - Uses --no-open flag to prevent browser popup during tests
    - Uses example.com for stable, fast network tests
    - Long timeouts (120s) for real network operations
    - Cleanup in afterAll to remove test artifacts
  </action>
  <verify>
    - File exists: src/cli/__tests__/e2e.test.ts
    - TypeScript compiles: npx tsc --noEmit
    - Tests run: npm test (should see e2e.test.ts in output)
  </verify>
  <done>
    - E2E test file created with comprehensive test cases
    - Tests cover: help, validation errors, full pipeline, device filtering
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Run and verify E2E tests</name>
  <files>-</files>
  <action>
    Run the full test suite to verify E2E tests work:

    1. Build the CLI first:
       ```bash
       npm run build
       ```

    2. Run all tests:
       ```bash
       npm test
       ```

    3. If any E2E tests fail, diagnose and fix:
       - Network issues: Check example.com is accessible
       - Timeout issues: Increase timeout if needed
       - Path issues: Verify dist/cli.js exists after build
       - Exit code issues: Check error handling in actions.ts

    4. Verify test count increased (was 284, should now be ~290+)

    Expected test breakdown:
    - help and version: 2 tests
    - validation errors: 3 tests
    - full pipeline: 1 test
    - device filtering: 1 test
    Total new: ~7 E2E tests
  </action>
  <verify>
    - npm test passes all tests
    - E2E tests specifically pass (grep output for "CLI E2E")
    - No orphan browser processes after test run: pgrep -f chromium (should return nothing)
  </verify>
  <done>
    - All tests pass including new E2E tests
    - Test count at ~291+ total
    - Clean test execution with no orphans
  </done>
</task>

</tasks>

<verification>
1. Dependency verification:
   ```bash
   npm ls execa strip-ansi
   ```
   Both should be listed in devDependencies.

2. Test file verification:
   ```bash
   ls -la src/cli/__tests__/e2e.test.ts
   ```
   File should exist.

3. Full test suite:
   ```bash
   npm test
   ```
   All tests should pass, including new E2E tests.

4. Orphan process check:
   ```bash
   pgrep -f chromium || echo "No orphan processes"
   ```
   Should show no orphan chromium processes.
</verification>

<success_criteria>
1. execa and strip-ansi installed as devDependencies
2. E2E test file exists with comprehensive test coverage
3. All tests pass (291+ total)
4. E2E tests validate full pipeline: CLI -> capture -> output -> report
5. Exit codes verified: 0 for success, 2 for validation errors
6. No orphan browser processes after tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-integration/10-02-SUMMARY.md`
</output>
